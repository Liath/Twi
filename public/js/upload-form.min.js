window.tags={};function addTag(a,c){var b=JSON.parse(a.val());if(0==b.length)b=[];else{var d=!1;b.forEach(function(b){b.n==c.n&&(d=!0)});if(d)return!1}"undefined"==typeof c.t?b.push({n:c.n,p:c.p}):b.push({n:c.n,p:c.p,t:1});b=jQuery.unique(b);a.val(JSON.stringify(b));return!0}function addTagLabel(a,c){0==a.html().length?a.append("Tags: "+genLabel(c)):a.append(", "+genLabel(c));dispelHook()}
function dispelHook(){$(".tagdispel").click(function(){if(null!=$(this).parent().html()){var a=$(this).parent().siblings(".upload-info-form"),c=JSON.parse(a.children(".file-tags").val()),b=[],d=$(this);c.forEach(function(a){a.n!=d.data("tag")&&b.push(a)});a.children(".file-tags").val(JSON.stringify(b));rebuildLabels(b,$(this).parent());dispelHook()}})}
function rebuildLabels(a,c){if(0==a.length)c.html("");else{var b="Tags: ";1==a.length?b+=genLabel(a[0]):(b+=genLabel(a.shift()),a.forEach(function(a){b+=", "+genLabel(a)}));c.html(b)}}
function genLabel(a){var c='<a class="label';"undefined"==typeof a.t?(tags.forEach(function(b){a.n==b.n&&(a=b)}),"undefined"!=typeof a.m&&"undefined"!=typeof a.m.t&&(c+=" label-"+a.m.t),c+='" href="/wiki/'+a.n+'">'+a.p+'</a><a data-tag="'+a.n+'" class="tagdispel">&cross;</a></span>'):c+='">'+a.p+'</a><a data-tag="'+a.n+'" class="tagdispel">&cross;</a></span>';return c}function toTitleCase(a){return a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()})}
window.delayFix=function(){$(".delayed").each(function(){$(this).removeClass("delayed");$(this).attr("src",$(this).data().imageurl)});$(".taglist").typeahead({source:window.tags,property:"p",onselect:function(a,c){$(".taglist").val("");addTag($(a.$element).siblings(".upload-info-form").children(".file-tags"),c)&&addTagLabel($(a.$element).siblings(".tags"),c)}});$(".taglist").keydown(function(a){if(13==a.keyCode&&!$(".taglist").data("typeahead").shown)return a={p:toTitleCase($(this).val()),n:$(this).val().toLowerCase().replace(/[^a-z0-9-]/g,
"-"),t:1},$(".taglist").val(""),addTag($(this).siblings(".upload-info-form").children(".file-tags"),a)&&addTagLabel($(this).siblings(".tags"),a),!1});$(".create-submit").click(function(){$(this).parent().siblings(".upload-info-form").submit();return!1});$(".upload-info-form").submit(function(a){$(a.currentTarget).parent().find("button").attr("disabled","disabled");$(a.currentTarget).parent().append('<div class="submit-overlay"></div>');var c=$(a.currentTarget).parent().children(".submit-overlay");
c.css({top:$(a.currentTarget).parent().parent().position().top,left:$(a.currentTarget).parent().parent().position().left,height:$(a.currentTarget).parent().parent().height(),width:$(a.currentTarget).parent().parent().width()});var b=$(a.currentTarget),d={tags:JSON.parse($(a.currentTarget).children(".file-tags").val()),source:$(a.currentTarget).children(".file-source").val()};$.post($(a.currentTarget).attr("action"),d,function(a){$.isArray(a)&&(a=a[0]);console.log("Data from server:");console.log(a);
$(c).remove();a.error?"Image already exists."==a.error?$(b).parent().html('<span class="submitted-message">Image already exists, go here to view it: <a href="'+a.path+'">'+a.path+'</a></span><button class="btn btn-warning right" onclick="$(this).parent().parent().remove()"><i class="icon-ban-circle icon-white"></i><span>Close</span></button>'):$(b).parent().html('<span class="submitted-message">Error'+a.error+'</span><button class="btn btn-warning right" onclick="$(this).parent().parent().remove()"><i class="icon-ban-circle icon-white"></i><span>Close</span></button>'):
$(b).parent().html('<span class="submitted-message">Done! <a href="/post/'+a.a+'">Click here to go to the post.</a></span><button class="btn btn-warning right" onclick="$(this).parent().parent().remove()"><i class="icon-ban-circle icon-white"></i><span>Close</span></button>')},"json");a.preventDefault();return!1})};
$(function(){$.getJSON("/s/tags",function(a){window.tags=a});$("#fileupload").fileupload();$("#fileupload").each(function(){var a=this;$.getJSON(this.action,function(c){c&&c.length&&$(a).fileupload("option","done").call(a,null,{result:c})})});$("#fileupload").bind("fileuploadcompleted",function(){setTimeout("delayFix()",1E3)})});
!function(a){var c=function(b,c){this.$element=a(b);this.options=a.extend({},a.fn.typeahead.defaults,c);this.matcher=this.options.matcher||this.matcher;this.sorter=this.options.sorter||this.sorter;this.highlighter=this.options.highlighter||this.highlighter;this.$menu=a(this.options.menu).appendTo("body");this.source=this.options.source;this.onselect=this.options.onselect;this.strings=!0;this.shown=!1;this.listen()};c.prototype={constructor:c,select:function(){var a=JSON.parse(this.$menu.find(".active").attr("data-value"));
this.$element.val(this.strings?a:a[this.options.property]);if("function"==typeof this.onselect)this.onselect(this,a);return this.hide()},show:function(){var b=a.extend({},this.$element.offset(),{height:this.$element[0].offsetHeight});this.$menu.css({top:b.top+b.height,left:b.left});this.$menu.show();this.shown=!0;return this},hide:function(){this.$menu.hide();this.shown=!1;return this},lookup:function(){var a;this.query=this.$element.val();"function"==typeof this.source?(a=this.source(this,this.query))&&
this.process(a):this.process(this.source)},process:function(b){var c=this;b.length&&"string"!=typeof b[0]&&(this.strings=!1);this.query=this.$element.val();if(!this.query)return this.shown?this.hide():this;b=a.grep(b,function(a){c.strings||(a=a[c.options.property]);if(c.matcher(a))return a});b=this.sorter(b);return!b.length?this.shown?this.hide():this:this.render(b.slice(0,this.options.items)).show()},matcher:function(a){return~a.toLowerCase().indexOf(this.query.toLowerCase())},sorter:function(a){for(var c=
[],f=[],e=[],g,h;g=a.shift();)h=this.strings?g:g[this.options.property],h.toLowerCase().indexOf(this.query.toLowerCase())?~h.indexOf(this.query)?f.push(g):e.push(g):c.push(g);return c.concat(f,e)},highlighter:function(a){return a.replace(RegExp("("+this.query+")","ig"),function(a,b){return"<strong>"+b+"</strong>"})},render:function(b){var c=this,b=a(b).map(function(b,e){b=a(c.options.item).attr("data-value",JSON.stringify(e));c.strings||(e=e[c.options.property]);b.find("a").html(c.highlighter(e));
return b[0]});b.first().addClass("active");this.$menu.html(b);return this},next:function(){var b=this.$menu.find(".active").removeClass("active").next();b.length||(b=a(this.$menu.find("li")[0]));b.addClass("active")},prev:function(){var a=this.$menu.find(".active").removeClass("active").prev();a.length||(a=this.$menu.find("li").last());a.addClass("active")},listen:function(){this.$element.on("blur",a.proxy(this.blur,this)).on("keypress",a.proxy(this.keypress,this)).on("keyup",a.proxy(this.keyup,this));
if(a.browser.webkit||a.browser.msie)this.$element.on("keydown",a.proxy(this.keypress,this));this.$menu.on("click",a.proxy(this.click,this)).on("mouseenter","li",a.proxy(this.mouseenter,this))},keyup:function(a){a.stopPropagation();a.preventDefault();switch(a.keyCode){case 40:case 38:break;case 9:case 13:if(!this.shown)break;this.select();break;case 27:this.hide();break;default:this.lookup()}},keypress:function(a){a.stopPropagation();if(this.shown)switch(a.keyCode){case 9:case 13:case 27:a.preventDefault();
break;case 38:a.preventDefault();this.prev();break;case 40:a.preventDefault(),this.next()}},blur:function(a){var c=this;a.stopPropagation();a.preventDefault();setTimeout(function(){c.hide()},150)},click:function(a){a.stopPropagation();a.preventDefault();this.select()},mouseenter:function(b){this.$menu.find(".active").removeClass("active");a(b.currentTarget).addClass("active")}};a.fn.typeahead=function(b){return this.each(function(){var d=a(this),f=d.data("typeahead"),e="object"==typeof b&&b;f||d.data("typeahead",
f=new c(this,e));if("string"==typeof b)f[b]()})};a.fn.typeahead.defaults={source:[],items:8,menu:'<ul class="typeahead dropdown-menu"></ul>',item:'<li><a href="#"></a></li>',onselect:null,property:"value"};a.fn.typeahead.Constructor=c;a(function(){a("body").on("focus.typeahead.data-api",'[data-provide="typeahead"]',function(b){var c=a(this);c.data("typeahead")||(b.preventDefault(),c.typeahead(c.data()))})})}(window.jQuery);
